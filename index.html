<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Web monetization session flow</title>
  <script defer class="remove" src="https://www.w3.org/Tools/respec/respec-w3c"></script>
  <script class="remove">
  // See: https://respec.org/docs/ for all configuration options
  var respecConfig = {
    shortName: "wm-session-flow",
    specStatus: "unofficial",
    noRecTrack: true,
    edDraftURI: "n/a",
    editors: [{
        name: "Alexander Surkov",
        mailto: "asurkov@igalia.com",
        company: "Igalia",
        companyURL: "https://igalia.com/",
        w3cid: "51089",
      },
      {
        name: "Radu Popa",
        mailto: "radu@interledger.foundation",
        company: "Interledger",
        companyURL: "https://interledger.org/",
      },
    ],
    authors: [{
      name: "Alexander Surkov",
      mailto: "asurkov@igalia.com",
      company: "Igalia",
      companyURL: "https://igalia.com/",
      w3cid: "51089",
    }, ],
    github: {
      repoURL: "asurkov/wm-session-flow",
      branch: "main",
    },
    localBiblio: {
      openpayments: {
        title: "Open Payments",
        href: "https://openpayments.dev/",
        status: "",
        publisher: "Interledger",
      },
      GNAP: {
        title: "GNAP",
        href: "https://datatracker.ietf.org/doc/html/draft-ietf-gnap-core-protocol",
        status: "",
        publisher: "",
      }
    },
    xref: [
      "csp",
      "dom",
      "ecmascript",
      "encoding",
      "html",
      "permissions-policy",
      "webcryptoapi",
      "webidl",
    ],
  };
  </script>
</head>

<body>
  <div data-include="section/abstract.html" data-include-replace="true"></div>
  <div data-include="section/sotd.html" data-include-replace="true"></div>
  <div data-include="section/introduction.html" data-include-replace="true"></div>
  <div data-include="section/terms.html" data-include-replace="true"></div>
  <div data-include="section/connecting-a-wallet.html" data-include-replace="true"></div>
 

  <section>
    <h2>Session flow</h2>

    <p>
      As long as the user lands on a [=web monetized website=] or interacts with
      [=web-monetized media=], and their preferences allow monetization for
      that site, the browser will attempt to initiate one or more
      [=monetization sessions=]. This section outlines the session flow, including
      when a session starts and stops, and how the browser facilitates payments
      from the user’s wallet to the website.
    </p>

    <h3>Open Payments requests</h3>

    <p><dfn>Incoming payment grant request</dfn> is a non-interactive
      <a href="https://openpayments.dev/apis/auth-server/operations/post-request/">OP grant request</a> to
      the [=authentication server=] of the [=website wallet provider=] to establish
      a payment flow from the [=user wallet=] to the [=website wallet=]. It requires
      a [=website wallet address=] given as |websiteWalletAddress| and an |amount|.
      The request body is formatted as follows:
      <pre class="nohighlight">
        {
          "access_token": {
            "access": [{
               "type": "incoming-payment",
                    "actions": ["create"],
                    "identifier": |websiteWalletAddress|
                }],
                "limits": {
                    "debitAmount": {
                        "amount": |amount| // FIXME: what it is set to?
                    }
                },
                // FIXME: is it website wallet address or user wallet address?
                "client": |websiteWalletAddress|
            }
        }
      </pre>
      and in response the server returns:
      <pre class="nohighlight">
        {
          continue: {
            access_token: {
              value: string // <a href="#dfn-access-token">access token</a>
            },
            uri: string, // <a href="#dfn-continuation-uri">continuation URI</a>
            wait: integer // <a href="#dfn-continuation-wait-time">continuation wait time</a>
          }
        }
        </pre>
    </p>

    <p><dfn>Incoming payment request</dfn> is an
      <a href="https://openpayments.dev/apis/resource-server/operations/create-incoming-payment">OP request</a>
      to the [=resource server=] of the [=website wallet provider=] for creating a [=payment bucket=] that
      accepts funds during the monetization session from the user.
      It requires
      <ul>
        <li>[=access token=] provided by the [=incoming payment grant request=],
          to be used in the authentication header;</li>
        <li>[=website wallet address=] given as |websiteWalletAddress|.</li>
      </ul>
      The |expiresAt| is an ISO string set to the
      current date plus 10 minutes.
      <div class="note">
        The |expiresAt| field is set to the current date plus 10 minutes, as users
        typically spend an average of 5 minutes on a website, making it unnecessary
        to keep the session active longer. Ideally, the browser should terminate
        the session when the user navigates away from the site. However, if that
        doesn’t happen for any reason, the expiration date will ensure the session
        is ended. If the session expires before the user leaves the website, the
        browser should reinitialize the session.
      </div>
      <div class="note">
        FIXME: The use of 10 minutes long |expiresAt| unnecessarily complicates things. The browser
        should handle shutting down the session when it is no longer active.
      </div>
      The request body is formatted as follows:
    </p>
    <pre class="nohighlight">
        {
          walletAddress: |websiteWalletAddress|,
          expiresAt: |expiresAt|
        }
        </pre>
    and in response the server returns:
    <pre class="nohighlight">
        {
          id: URL // <a href="#dfn-payment-bucket">payment bucket</a>
        }
        </pre>
    </p>

    <p>
      <dfn>Outgoing payment request</dfn> is an
      <a href="https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment">OP request</a>
      to the [=resource server=] of the [=user wallet provider=] to transfer funds into
      the [=payment bucket=] of the [=website wallet=]. It requires
      <ul>
        <li>[=access token=] from the [=continuation grant request=] when the user connected their
          [=user wallet=] to the browser, included in the authentification header,</li>
        <li>[=user wallet address=] given as |userWalletAddress|,</li>
        <li>[=payment bucket=] given as |paymentBucketURI|,</li>
        <li>amount to transfer given as |amount|,</li>
        <li>[=asset code=] given as |assetCode|,</li>
        <li>[=asset scale=] given as |assetScale|.</li>
      </ul>
      The request body is formatted as follows:
      <pre class="nohighlight">
        {
          walletAddress: |userWalletAddress|,
          incomingPayment: |paymentBucketURI|,
          debitAmount: {
            value: |amount|,
            assetCode: |assetCode|,
            assetScale: |assetScale|,
          }
        }
        </pre>
      and in response the server returns:
      <pre class="nohighlight">
        {
          receiveAmount: {
            value: integer, // amount sent
            assetCode: string, // <a href="#dfn-asset-code">asset code</a>
            assetScale: integer // <a href="#dfn-asset-code">asset scale</a>
          }
        }
        </pre>
    </p>

    <h3>Session lifecycle</h3>

    <p>
      A <dfn data-lt="active session list">active sessions</dfn> is used to store
      information about active monetization sessions. The storage is implemented
      as a linked list of {{MonetizationSession}} objects.
    </p>

    <pre class="idl">
        dictionary MonetizationSession {
          HTMLLinkElement linkElement; // monetization HTML link
          USVString walletAddress; // wallet address
          USVString assetCode; // asset scale of the wallet
          unsigned long assetScale; // asset code of the wallet
          USVString paymentBucketURI; // a payment bucket created for the session
        };
      </pre>

    <p>
      As soon as a [=web monetized website=]'s document becomes [=Document/fully active=],
      [=document-wide sessions are initiated=] for a {{Document}} of the website.
    </p>

    <p>
      If a {{Document}} becomes not [=Document/fully active=] then
      [=suspend session=] for it and all its [=child navigables=].
    </p>

    <p>
      If any of the conditions outlined in the
      <a href="https://webmonetization.org/specification/#link-type-monetization">
        link fetch and processing timing
      </a> are met for a
      <a href="https://webmonetization.org/specification/#link-type-monetization">
        monetization
      </a> [^link^] element, then the associated [=session is suspended=], and
      a new [=session is initiated=] for the given link element.
    </p>

    <p>
      As soon as the user starts interacting with a [=web-monetized media=] on a
      website, [=sessions are initiated=] scoped to the [=media element=].
    </p>

    <p>
      As soon as the user stops interacting with a [=web-monetized media=] on a
      website, any [=media element=] associated [=session is suspended=].
    </p>

    <p class="note">
      Monetization typically starts when the user loads a website, switches back to
      the browser, or switches to an existing tab with an already loaded website.
      For media elements, monetization begins as soon as the user interacts with
      them, such as watching a video or listening to audio, and stops when the user
      ceases the interaction.
    </p>

    <h3>Session initiation</h3>

    <p>
      To <dfn data-lt="document-wide sessions are initiated">initiate document-wide
        sessions</dfn> for a given {{Document}} |document|, perform the following steps:
      <ol>
        <li>[=Initiate sessions scoped to=] the [^head^] element of the |document|.</li>
        <li>For each [=child navigable=] of the |document|, recursively
          [=initiate document-wide sessions=].</li>
      </ol>
    </p>

    <p>
      To <dfn data-lt="sessions are initiated">initiate sessions scoped to</dfn>
      the given {{HTMLElement}} as |root|, run these steps:
      <ul>
        <li>Let |linkElements| be a {{NodeList}} of all HTML [^link^] elements with
          the `rel="monetization"` attribute from the children of the |root|.</li>
        <li>For each element from |linkElements|, [=initiate a session=].</li>
      </ul>
    </p>

    <p>
      To <dfn data-lt="session is initiated">initiate a session</dfn> for a `monetization`
      [^link^] element, run these steps:
      <ol>
        <li>Let |linkElement:HTMLLinkElement| be the given [^link^] element.</li>
        <li>Let |document:Document| be the {{Node/ownerDocument}} of the |linkElement|.</li>
        <li>If [=monetization is disabled=] given the |document|, then return.</li>

        <li>Let |websiteWalletAddress| be the value of the `href` attribute of |linkElement|.</li>
        <li>If [=monetization is disabled for a wallet=] given the |document| and |websiteWalletAddress|, then return.</li>

        <li><dfn>Get website wallet address step</dfn>. Send
          [=get wallet address request=] to |websiteWalletAddress|.</li>
        <li>If the [=get website wallet address step=] request fails, fire an `error`
          event on |linkElement| and return.</li>

        <li>Fire `load` event on |linkElement|.</li>

        <li>Let |authServer| be the [=authentication server=] from the
          [=get website wallet address step=] response.</li>
        <li><dfn>Incoming payment grant step</dfn>. Send an
          [=incoming payment grant request=] to |authServer|, with |websiteWalletAddress|
          and |amount| (FIXME).</li>
        <li>If the [=incoming payment grant step=] request fails, return.</li>

        <li>Let |resourceServer| be the [=resource server=] from the
          [=get website wallet address step=] response.</li>
        <li>Let |accessToken| be the [=access token=] from the [=incoming payment grant step=].</li>
        <li><dfn>Incoming payment step</dfn>. Send an [=incoming payment request=] to
          |resourceServer|, with |accessToken| and |websiteWalletAddress|.</li>
        <li>If the [=incoming payment step=] request fails, return.</li>

        <li>Let |continuationURI| be the [=continuation URI=] from the
          [=incoming payment grant step=] response.</li>
        <li>Revoke the grant obtained at the [=incoming payment grant step=] by sending a
          [=cancel grant request=] to |continuationURI| using |accessToken|.</li>

        <li>Let |assetCode| be the [=asset code=] from the
          [=get website wallet address step=] response.</li>
        <li>Let |assetScale| be the [=asset scale=] from the
          [=get website wallet address step=] response.</li>
        <li>Let |paymentBucketURI| be the [=payment bucket=] from the
          [=incoming payment step=] response.</li>

        <li>Let |session:MonetizationSession| be a new {{MonetizationSession}} object
          with `linkElement` set to |linkElement|,
          `walletAddress` set to |websiteWalletAddress|, `assetCode` set to |assetCode|,
          `assetScale` set to |assetScale|, and `paymentBucketURI` set to |paymentBucketURI|.
        </li>

        <li>Append the |session| to the [=active session list=].

        <li>
          If the [=active session list=] length is 1, [=start session loop=].
        </li>
      </ol>
    </p>

    <h3>Payment distribution</h3>

    <div class="note">
      <p>
        The payment algorithm distributes payments equally between
        [=website wallets=] of the [=active sessions=], with payments made at equal time
        intervals, defaulting to `1s` if a website wallet can accept the given amount.
        If the website wallet's cannot accommodate the default amount, the payment
        is delayed by a number of seconds to accommodate the increased amount as
        defined by the [=asset scale=] of the [=website wallet=].
      </p>
      <p>
        As soon as the first session is added to the [=active sessions=], each session
        from the [=active sessions=] is processed one by one, with payments sent accordingly,
        and the processing continues until the [=active sessions=] list is empty.
      </p>
    </div>

    <div class="note">
      <p>
        Website wallets with an asset code different from the user wallet's asset
        code are <b>ignored</b> until the exchange rate issue is resolved.
      </p>
      <p>
        The current design suggests that the browser must rely on third-party currency
        conversion services to estimate the payment amount for the website wallet.
        However, handling the conversion rate seems like a natural part of OpenPayments,
        as it removes the need for the browser to estimate exchange rates, leaving this
        task to the wallet provider that performs the actual currency conversion.
        This approach also eliminates the browser's dependency on third-party services,
        resulting in a simpler design.
      </p>
    </div>

    <p>
      A <dfn>session loop</dfn> is an asynchronous process that iterates through
      the [=active sessions=], during which the browser [=sends payments=]
      to the [=website wallet=] associated with each session from the [=active sessions=].
    </p>

    <p>
      A <dfn>currently processed session</dfn> is a {{MonetizationSession}} object from the
      [=active sessions=] that the browser is processing within the [=session loop=].
    </p>

    <p>
      A <dfn>session loop timeout</dfn> is the delay before the browser
      [=sends payment=] to the [=website wallet=] of the [=currently processed session=]
      and then proceeds to the next session from the [=active session list=].
    </p>

    <p>
      A <dfn>payment amount</dfn> is the payment made to a [=website wallet=] of
      the [=currently processed session=].
    </p>

    <p>
      To compute [=payment amount=] and [=session loop timeout=]</dfn>
      for the [=currently processed session=] given as |session|, run these steps:
      <ul>
        <li>Let |defaultTimeout| be `1`.</li>
        <li>Let |userWalletDetails| be the [=user wallet details=].</li>
        <li>Let |defaultAmount| be `userWalletDetails.payRate / 3600`.</li>
        <li>Let |assetScale| be `session.assetScale`.</li>
        <li>Let |minimalAmount| be `1 / Math.pow(10, |assetScale|)` using {{Math/pow()}}.</li>

        <li>Then <dfn data-lt="computed payment amount">payment amount is computed</dfn> as:<br>
          <code>max(|defaultAmount|, minimalAmount)</code> using {{Math/max()}}.
        </li>

        <li>Then <dfn data-lt="computed session loop timeout">session loop timeout is computed</dfn> as:<br>
          <code>max(|defaultTimeout|, ceil(|minimalAmount| / |defaultAmount|))</code>
          using {{Math/ceil(x)}}, {{Math/max()}}.
        </li>
      </ul>
    </p>

    <h3>Session loop</h3>

    <p>
      To <dfn>start session loop</dfn>, [=schedule next session processing=] given null.
    </p>

    <p>A <dfn>session processing runnable</dfn> is a function called
      in [=session loop timeout=] which [=processes current session=].</p>

    <p>
      To <dfn>schedule next session processing</dfn> given an optional |session|, run these steps:
      <ol>
        <li>[=Set next session=] given the |session|.</li>
        <li>If the [=currently processed session=] is null, then return.</li>
        <li>Let |timeout| be the [=computed session loop timeout=].</li>
        <li>Create a [=session processing runnable=]
          and schedule it to be triggered after |timeout|.</li>
      </ol>
    </p>

    <p>To <dfn data-lt="processes current session">process current session</dfn>, run these steps:
      <ol>
        <li>[=Send payment=] given the [=currently processed session=].</li>
        <li>[=Schedule next session processing=] given the [=currently processed session=].</li>
      </ol>
    </p>

    <p>
      To <dfn>set next session</dfn> given an optional {{MonetizationSession}} |session|,
      run these steps:
      <ol>
        <li>If the [=active session list=] is empty, set the
          [=currently processed session=] to null.</li>
        <li>Otherwise, |session| is null or if there are no sessions following |session|, set the
          [=currently processed session=] to the first session in the
          [=active session list=].</li>
        <li>Otherwise, set the [=currently processed session=] to the session
          following |session| in the [=active session list=].</li>
      </ol>
    </p>

    <p>
      To <dfn data-lt="sends payments">send payment</dfn> given a
      {{MonetizationSession}} as |session|, run these steps:
      <ol>
        <li>Let |userWalletDetails| be the [=user wallet details=].</li>
        <li>Let |userWalletAddress| be |userWalletDetails|`.address`.</li>
        <li>Let |accessToken| be |userWalletDetails|`.accessToken`.</li>
        <li>Let |paymentBucketURI| be |session|`.paymentBucketURI`.</li>
        <li>Let |amount| be the [=computed payment amount=].</li>
        <li>Let |accessCode| be |session|`.accessCode`.</li>
        <li>Let |accessScale| be |session|`.accessScale`.</li>
        <li><dfn>Outgoing payment step</dfn>. Send [=outgoing payment request=] given
          |accessToken|, |userWalletDetails|, |paymentBucketURI|, |amount|, |assetCode|, |assetScale|.</li>
        <li>If the request from the [=outgoing payment step=] fails, then return.</li>
        <li>Let |linkElement:HTMLLinkElement| be |session|`.linkElement`.</li>
        <li>Let |websiteWalletAddress| be |session|`.walletAddress`.</li>
        <li>Set |amount| be the amount from the response of the [=outgoing payment step=].</li>
        <li>Set |assetCode| be the [=asset code=] from the response of the
          [=outgoing payment step=].</li>
        <li>Set |assetScale| be the [=asset scale=] from the response of the
          [=outgoing payment step=].</li>
        <li>Fire a <a href="https://webmonetization.org/specification/#dom-monetizationevent">
            `MonetizationEvent`</a> event on the |linkElement| element, initialized with the
          <a href="https://webmonetization.org/specification/#dom-monetizationeventinit">
            `MonetizationEventInit`</a> structure, having the fields `amount` set to
          |amount|, `assetCode` set to |assetCode|, `assetScale` set to |assetScale|,
          `paymentPointer` set to |websiteWalletAddress|, and `incomingPayment` set
          to |paymentBucketURI|.</li>
      </ol>
    </p>

    <h3>Session suspension</h3>

    <p>
      To <dfn data-lt="session is suspended">suspend session</dfn> given a
      {{MonetizationSession}} as |session|, run these steps:
      <ol>
        <li>If |session| is the [=currently processed session=], then
          <ol>
            <Li>Cancel the [=session processing runnable=] if any.</Li>
            <li>[=Schedule next session processing=] given |session|.
          </ol>
        </li>
        <li>Remove |session| from the [=active session list=].</li>
      </ol>
    </p>
  </section>

  <section id="questions">
    <h2>Open questions</h2>
    <ul>
      <li>Look for `FIXME` labels.</li>
    </ul>
  </section>
</body>

</html>
